import { createContext, useContext, useState, useEffect, type ReactNode } from 'react';

export type Lang = 'es' | 'en' | 'gl';

export const LANGUAGES: { code: Lang; label: string; flag: string }[] = [
    { code: 'es', label: 'Español', flag: '/flags/es.svg' },
    { code: 'en', label: 'English', flag: '/flags/en.svg' },
    { code: 'gl', label: 'Galego', flag: '/flags/gl.svg' },
];

const translations: Record<Lang, Record<string, string>> = {
    es: {
        // Auth
        'auth.login': 'Iniciar sesión',
        'auth.register': 'Registrarse',
        'auth.login_desc': 'Introduce tus credenciales para acceder a tu bóveda',
        'auth.register_desc': 'Crea una cuenta para proteger tus contraseñas',
        'auth.username': 'Nombre de usuario',
        'auth.master_password': 'Contraseña maestra',
        'auth.confirm_password': 'Confirmar contraseña',
        'auth.create_account': 'Crear cuenta',
        'auth.passwords_mismatch': 'Las contraseñas no coinciden',
        'auth.password_min_length': 'La contraseña debe tener al menos 8 caracteres',
        'auth.username_min_length': 'El nombre de usuario debe tener al menos 3 caracteres',
        'auth.login_success': 'Sesión iniciada',
        'auth.register_success': 'Cuenta creada correctamente',
        'auth.master_warning': 'Tu contraseña maestra cifra todas tus credenciales.',
        'auth.master_warning2': 'No se puede recuperar si la olvidas.',

        // Lock
        'lock.unlock_desc': 'Introduce tu contraseña maestra para desbloquear',
        'lock.setup_desc': 'Crea una contraseña maestra para proteger tu bóveda',
        'lock.confirm_master': 'Confirmar contraseña maestra',
        'lock.unlock': 'Desbloquear',
        'lock.create_master': 'Crear contraseña maestra',
        'lock.master_min_length': 'La contraseña maestra debe tener al menos 8 caracteres',
        'lock.unlocked': 'Bóveda desbloqueada',
        'lock.master_configured': 'Contraseña maestra configurada',
        'lock.encrypts_warning': 'Esta contraseña cifra todas tus credenciales almacenadas.',

        // Layout / Nav
        'nav.generator': 'Generador',
        'nav.checker': 'Verificador',
        'nav.vault': 'Bóveda',
        'nav.logout': 'Cerrar sesión',
        'nav.logout_success': 'Sesión cerrada',
        'nav.logout_error': 'Error al cerrar sesión',
        'nav.dark_mode': 'Modo oscuro',
        'nav.light_mode': 'Modo claro',

        // Generator
        'gen.title': 'Generador de Contraseñas',
        'gen.subtitle': 'Genera contraseñas robustas con distintos métodos criptográficamente seguros',
        'gen.config': 'Configuración',
        'gen.random': 'Aleatorio',
        'gen.passphrase': 'Frase',
        'gen.pin': 'PIN',
        'gen.random_desc': 'Caracteres aleatorios criptográficamente seguros',
        'gen.passphrase_desc': 'Palabras aleatorias fáciles de recordar',
        'gen.pin_desc': 'Solo dígitos numéricos',
        'gen.length': 'Longitud',
        'gen.include_chars': 'Incluir caracteres',
        'gen.uppercase': 'Mayúsculas (A-Z)',
        'gen.lowercase': 'Minúsculas (a-z)',
        'gen.digits': 'Números (0-9)',
        'gen.symbols': 'Símbolos (!@#$...)',
        'gen.generate': 'Generar Contraseña',
        'gen.result': 'Resultado',
        'gen.copied': 'Contraseña copiada',
        'gen.entropy_bits': 'bits de entropía',
        'gen.entropy': 'Entropía',
        'gen.crack_time': 'Tiempo de crackeo',
        'gen.regenerate': 'Regenerar',
        'gen.save': 'Guardar',
        'gen.placeholder': 'Configura y genera una contraseña',
        'gen.placeholder_sub': 'Usa los controles de la izquierda',
        'gen.num_words': 'Número de palabras',
        'gen.separator': 'Separador',
        'gen.pin_length': 'Longitud del PIN',

        // Strength
        'strength.very_weak': 'Muy débil',
        'strength.weak': 'Débil',
        'strength.moderate': 'Moderada',
        'strength.strong': 'Fuerte',
        'strength.very_strong': 'Muy fuerte',

        // Checker
        'check.title': 'Verificador de Contraseñas',
        'check.subtitle': 'Analiza la fortaleza de tu contraseña y comprueba si ha sido filtrada',
        'check.placeholder': 'Introduce la contraseña a verificar...',
        'check.verify': 'Verificar',
        'check.enter_password': 'Introduce una contraseña',
        'check.breached': '¡Contraseña filtrada!',
        'check.breached_desc_pre': 'Esta contraseña ha aparecido en ',
        'check.breached_desc_post': ' filtraciones de datos conocidas. ¡Cámbiala inmediatamente!',
        'check.safe': 'No encontrada en filtraciones',
        'check.safe_desc': 'Esta contraseña no aparece en bases de datos de filtraciones conocidas.',
        'check.strength': 'Fortaleza',
        'check.estimated_crack': 'Crackeo estimado',
        'check.recommendations': 'Recomendaciones',
        'check.char_distribution': 'Distribución de caracteres',
        'check.cumulative_entropy': 'Entropía acumulada',
        'check.lowercase': 'Minúsculas',
        'check.uppercase': 'Mayúsculas',
        'check.digits_label': 'Números',
        'check.symbols_label': 'Símbolos',
        'check.other': 'Otros',

        // Vault
        'vault.title': 'Bóveda',
        'vault.count_one': 'contraseña almacenada',
        'vault.count_many': 'contraseñas almacenadas',
        'vault.add': 'Añadir',
        'vault.search': 'Buscar por título, usuario o URL...',
        'vault.filters': 'Filtros',
        'vault.favorites_only': 'Solo favoritos',
        'vault.tags': 'Etiquetas:',
        'vault.all': 'Todas',
        'vault.new_tag': 'Nueva',
        'vault.tag_name': 'Nombre de la etiqueta',
        'vault.create': 'Crear',
        'vault.empty': 'No hay contraseñas almacenadas',
        'vault.empty_desc': 'Genera una contraseña y guárdala, o añade una manualmente',
        'vault.user': 'Usuario:',
        'vault.copy': 'Copiar contraseña',
        'vault.open_url': 'Abrir URL',
        'vault.delete': 'Eliminar',
        'vault.deleted': 'Entrada eliminada',
        'vault.tag_created': 'Etiqueta creada',
        'vault.confirm_delete': '¿Estás seguro de eliminar esta entrada?',
        'vault.password_copied': 'Contraseña copiada',
        'vault.show': 'Mostrar',
        'vault.hide': 'Ocultar',

        // Save modal
        'save.title': 'Guardar en Bóveda',
        'save.entry_title': 'Título *',
        'save.entry_title_placeholder': 'ej: Gmail, Netflix, Banco...',
        'save.user_email': 'Usuario / Email',
        'save.user_email_placeholder': 'ej: usuario@email.com',
        'save.url': 'URL',
        'save.url_placeholder': 'ej: https://www.ejemplo.com',
        'save.password': 'Contraseña *',
        'save.password_placeholder': 'Introduce la contraseña',
        'save.notes': 'Notas',
        'save.notes_placeholder': 'Notas adicionales...',
        'save.favorite': 'Favorito',
        'save.mark_favorite': 'Marcar como favorito',
        'save.tags': 'Etiquetas',
        'save.cancel': 'Cancelar',
        'save.save': 'Guardar',
        'save.required': 'Título y contraseña son obligatorios',
        'save.saved': 'Contraseña guardada en la bóveda',

        // App
        'app.loading': 'Cargando Sekure...',

        // Chart
        'chart.no_data': 'Sin datos',
    },

    en: {
        'auth.login': 'Log in',
        'auth.register': 'Sign up',
        'auth.login_desc': 'Enter your credentials to access your vault',
        'auth.register_desc': 'Create an account to protect your passwords',
        'auth.username': 'Username',
        'auth.master_password': 'Master password',
        'auth.confirm_password': 'Confirm password',
        'auth.create_account': 'Create account',
        'auth.passwords_mismatch': 'Passwords do not match',
        'auth.password_min_length': 'Password must be at least 8 characters',
        'auth.username_min_length': 'Username must be at least 3 characters',
        'auth.login_success': 'Logged in',
        'auth.register_success': 'Account created successfully',
        'auth.master_warning': 'Your master password encrypts all your credentials.',
        'auth.master_warning2': 'It cannot be recovered if you forget it.',

        'lock.unlock_desc': 'Enter your master password to unlock',
        'lock.setup_desc': 'Create a master password to protect your vault',
        'lock.confirm_master': 'Confirm master password',
        'lock.unlock': 'Unlock',
        'lock.create_master': 'Create master password',
        'lock.master_min_length': 'Master password must be at least 8 characters',
        'lock.unlocked': 'Vault unlocked',
        'lock.master_configured': 'Master password configured',
        'lock.encrypts_warning': 'This password encrypts all your stored credentials.',

        'nav.generator': 'Generator',
        'nav.checker': 'Checker',
        'nav.vault': 'Vault',
        'nav.logout': 'Log out',
        'nav.logout_success': 'Logged out',
        'nav.logout_error': 'Error logging out',
        'nav.dark_mode': 'Dark mode',
        'nav.light_mode': 'Light mode',

        'gen.title': 'Password Generator',
        'gen.subtitle': 'Generate robust passwords with different cryptographically secure methods',
        'gen.config': 'Configuration',
        'gen.random': 'Random',
        'gen.passphrase': 'Phrase',
        'gen.pin': 'PIN',
        'gen.random_desc': 'Cryptographically secure random characters',
        'gen.passphrase_desc': 'Easy-to-remember random words',
        'gen.pin_desc': 'Numeric digits only',
        'gen.length': 'Length',
        'gen.include_chars': 'Include characters',
        'gen.uppercase': 'Uppercase (A-Z)',
        'gen.lowercase': 'Lowercase (a-z)',
        'gen.digits': 'Numbers (0-9)',
        'gen.symbols': 'Symbols (!@#$...)',
        'gen.generate': 'Generate Password',
        'gen.result': 'Result',
        'gen.copied': 'Password copied',
        'gen.entropy_bits': 'bits of entropy',
        'gen.entropy': 'Entropy',
        'gen.crack_time': 'Crack time',
        'gen.regenerate': 'Regenerate',
        'gen.save': 'Save',
        'gen.placeholder': 'Configure and generate a password',
        'gen.placeholder_sub': 'Use the controls on the left',
        'gen.num_words': 'Number of words',
        'gen.separator': 'Separator',
        'gen.pin_length': 'PIN length',

        'strength.very_weak': 'Very weak',
        'strength.weak': 'Weak',
        'strength.moderate': 'Moderate',
        'strength.strong': 'Strong',
        'strength.very_strong': 'Very strong',

        'check.title': 'Password Checker',
        'check.subtitle': 'Analyze the strength of your password and check if it has been leaked',
        'check.placeholder': 'Enter the password to check...',
        'check.verify': 'Check',
        'check.enter_password': 'Enter a password',
        'check.breached': 'Password breached!',
        'check.breached_desc_pre': 'This password has appeared in ',
        'check.breached_desc_post': ' known data breaches. Change it immediately!',
        'check.safe': 'Not found in breaches',
        'check.safe_desc': 'This password does not appear in known breach databases.',
        'check.strength': 'Strength',
        'check.estimated_crack': 'Estimated crack',
        'check.recommendations': 'Recommendations',
        'check.char_distribution': 'Character distribution',
        'check.cumulative_entropy': 'Cumulative entropy',
        'check.lowercase': 'Lowercase',
        'check.uppercase': 'Uppercase',
        'check.digits_label': 'Numbers',
        'check.symbols_label': 'Symbols',
        'check.other': 'Other',

        'vault.title': 'Vault',
        'vault.count_one': 'password stored',
        'vault.count_many': 'passwords stored',
        'vault.add': 'Add',
        'vault.search': 'Search by title, username or URL...',
        'vault.filters': 'Filters',
        'vault.favorites_only': 'Favorites only',
        'vault.tags': 'Tags:',
        'vault.all': 'All',
        'vault.new_tag': 'New',
        'vault.tag_name': 'Tag name',
        'vault.create': 'Create',
        'vault.empty': 'No passwords stored',
        'vault.empty_desc': 'Generate a password and save it, or add one manually',
        'vault.user': 'User:',
        'vault.copy': 'Copy password',
        'vault.open_url': 'Open URL',
        'vault.delete': 'Delete',
        'vault.deleted': 'Entry deleted',
        'vault.tag_created': 'Tag created',
        'vault.confirm_delete': 'Are you sure you want to delete this entry?',
        'vault.password_copied': 'Password copied',
        'vault.show': 'Show',
        'vault.hide': 'Hide',

        'save.title': 'Save to Vault',
        'save.entry_title': 'Title *',
        'save.entry_title_placeholder': 'e.g.: Gmail, Netflix, Bank...',
        'save.user_email': 'User / Email',
        'save.user_email_placeholder': 'e.g.: user@email.com',
        'save.url': 'URL',
        'save.url_placeholder': 'e.g.: https://www.example.com',
        'save.password': 'Password *',
        'save.password_placeholder': 'Enter the password',
        'save.notes': 'Notes',
        'save.notes_placeholder': 'Additional notes...',
        'save.favorite': 'Favorite',
        'save.mark_favorite': 'Mark as favorite',
        'save.tags': 'Tags',
        'save.cancel': 'Cancel',
        'save.save': 'Save',
        'save.required': 'Title and password are required',
        'save.saved': 'Password saved to vault',

        'app.loading': 'Loading Sekure...',
        'chart.no_data': 'No data',
    },

    gl: {
        'auth.login': 'Iniciar sesión',
        'auth.register': 'Rexistrarse',
        'auth.login_desc': 'Introduce as túas credenciais para acceder a túa bóveda',
        'auth.register_desc': 'Crea unha conta para protexer os teus contrasinais',
        'auth.username': 'Nome de usuario',
        'auth.master_password': 'Contrasinal mestra',
        'auth.confirm_password': 'Confirmar contrasinal',
        'auth.create_account': 'Crear conta',
        'auth.passwords_mismatch': 'Os contrasinais non coinciden',
        'auth.password_min_length': 'O contrasinal debe ter polo menos 8 caracteres',
        'auth.username_min_length': 'O nome de usuario debe ter polo menos 3 caracteres',
        'auth.login_success': 'Sesión iniciada',
        'auth.register_success': 'Conta creada correctamente',
        'auth.master_warning': 'O teu contrasinal mestra cifra todas as túas credenciais.',
        'auth.master_warning2': 'Non se pode recuperar se o esqueces.',

        'lock.unlock_desc': 'Introduce o teu contrasinal mestra para desbloquear',
        'lock.setup_desc': 'Crea un contrasinal mestra para protexer a túa bóveda',
        'lock.confirm_master': 'Confirmar contrasinal mestra',
        'lock.unlock': 'Desbloquear',
        'lock.create_master': 'Crear contrasinal mestra',
        'lock.master_min_length': 'O contrasinal mestra debe ter polo menos 8 caracteres',
        'lock.unlocked': 'Bóveda desbloqueada',
        'lock.master_configured': 'Contrasinal mestra configurado',
        'lock.encrypts_warning': 'Este contrasinal cifra todas as túas credenciais almacenadas.',

        'nav.generator': 'Xerador',
        'nav.checker': 'Verificador',
        'nav.vault': 'Bóveda',
        'nav.logout': 'Pechar sesión',
        'nav.logout_success': 'Sesión pechada',
        'nav.logout_error': 'Erro ao pechar sesión',
        'nav.dark_mode': 'Modo escuro',
        'nav.light_mode': 'Modo claro',

        'gen.title': 'Xerador de Contrasinais',
        'gen.subtitle': 'Xera contrasinais robustos con distintos métodos criptograficamente seguros',
        'gen.config': 'Configuración',
        'gen.random': 'Aleatorio',
        'gen.passphrase': 'Frase',
        'gen.pin': 'PIN',
        'gen.random_desc': 'Caracteres aleatorios criptograficamente seguros',
        'gen.passphrase_desc': 'Palabras aleatorias fáciles de lembrar',
        'gen.pin_desc': 'Só díxitos numéricos',
        'gen.length': 'Lonxitude',
        'gen.include_chars': 'Incluír caracteres',
        'gen.uppercase': 'Maiúsculas (A-Z)',
        'gen.lowercase': 'Minúsculas (a-z)',
        'gen.digits': 'Números (0-9)',
        'gen.symbols': 'Símbolos (!@#$...)',
        'gen.generate': 'Xerar Contrasinal',
        'gen.result': 'Resultado',
        'gen.copied': 'Contrasinal copiado',
        'gen.entropy_bits': 'bits de entropía',
        'gen.entropy': 'Entropía',
        'gen.crack_time': 'Tempo de crackeo',
        'gen.regenerate': 'Rexenerar',
        'gen.save': 'Gardar',
        'gen.placeholder': 'Configura e xera un contrasinal',
        'gen.placeholder_sub': 'Usa os controis da esquerda',
        'gen.num_words': 'Número de palabras',
        'gen.separator': 'Separador',
        'gen.pin_length': 'Lonxitude do PIN',

        'strength.very_weak': 'Moi débil',
        'strength.weak': 'Débil',
        'strength.moderate': 'Moderada',
        'strength.strong': 'Forte',
        'strength.very_strong': 'Moi forte',

        'check.title': 'Verificador de Contrasinais',
        'check.subtitle': 'Analiza a fortaleza do teu contrasinal e comproba se foi filtrado',
        'check.placeholder': 'Introduce o contrasinal a verificar...',
        'check.verify': 'Verificar',
        'check.enter_password': 'Introduce un contrasinal',
        'check.breached': 'Contrasinal filtrado!',
        'check.breached_desc_pre': 'Este contrasinal apareceu en ',
        'check.breached_desc_post': ' filtracións de datos coñecidas. Cámbiao inmediatamente!',
        'check.safe': 'Non atopado en filtracións',
        'check.safe_desc': 'Este contrasinal non aparece en bases de datos de filtracións coñecidas.',
        'check.strength': 'Fortaleza',
        'check.estimated_crack': 'Crackeo estimado',
        'check.recommendations': 'Recomendacións',
        'check.char_distribution': 'Distribución de caracteres',
        'check.cumulative_entropy': 'Entropía acumulada',
        'check.lowercase': 'Minúsculas',
        'check.uppercase': 'Maiúsculas',
        'check.digits_label': 'Números',
        'check.symbols_label': 'Símbolos',
        'check.other': 'Outros',

        'vault.title': 'Bóveda',
        'vault.count_one': 'contrasinal almacenado',
        'vault.count_many': 'contrasinais almacenados',
        'vault.add': 'Engadir',
        'vault.search': 'Buscar por título, usuario ou URL...',
        'vault.filters': 'Filtros',
        'vault.favorites_only': 'Só favoritos',
        'vault.tags': 'Etiquetas:',
        'vault.all': 'Todas',
        'vault.new_tag': 'Nova',
        'vault.tag_name': 'Nome da etiqueta',
        'vault.create': 'Crear',
        'vault.empty': 'Non hai contrasinais almacenados',
        'vault.empty_desc': 'Xera un contrasinal e gárdao, ou engade un manualmente',
        'vault.user': 'Usuario:',
        'vault.copy': 'Copiar contrasinal',
        'vault.open_url': 'Abrir URL',
        'vault.delete': 'Eliminar',
        'vault.deleted': 'Entrada eliminada',
        'vault.tag_created': 'Etiqueta creada',
        'vault.confirm_delete': 'Estás seguro de eliminar esta entrada?',
        'vault.password_copied': 'Contrasinal copiado',
        'vault.show': 'Amosar',
        'vault.hide': 'Ocultar',

        'save.title': 'Gardar na Bóveda',
        'save.entry_title': 'Título *',
        'save.entry_title_placeholder': 'ex: Gmail, Netflix, Banco...',
        'save.user_email': 'Usuario / Email',
        'save.user_email_placeholder': 'ex: usuario@email.com',
        'save.url': 'URL',
        'save.url_placeholder': 'ex: https://www.exemplo.com',
        'save.password': 'Contrasinal *',
        'save.password_placeholder': 'Introduce o contrasinal',
        'save.notes': 'Notas',
        'save.notes_placeholder': 'Notas adicionais...',
        'save.favorite': 'Favorito',
        'save.mark_favorite': 'Marcar como favorito',
        'save.tags': 'Etiquetas',
        'save.cancel': 'Cancelar',
        'save.save': 'Gardar',
        'save.required': 'Título e contrasinal son obrigatorios',
        'save.saved': 'Contrasinal gardado na bóveda',

        'app.loading': 'Cargando Sekure...',
        'chart.no_data': 'Sen datos',
    },
};

function detectLanguage(): Lang {
    const stored = localStorage.getItem('sekure-lang');
    if (stored && (stored === 'es' || stored === 'en' || stored === 'gl')) {
        return stored as Lang;
    }
    const browserLang = navigator.language.substring(0, 2).toLowerCase();
    if (browserLang === 'en') return 'en';
    if (browserLang === 'gl') return 'gl';
    return 'es'; // default
}

interface LanguageContextType {
    lang: Lang;
    setLang: (lang: Lang) => void;
    t: (key: string) => string;
}

const LanguageContext = createContext<LanguageContextType>({
    lang: 'es',
    setLang: () => { },
    t: (key) => key,
});

export function useLanguage() {
    return useContext(LanguageContext);
}

export function LanguageProvider({ children }: { children: ReactNode }) {
    const [lang, setLangState] = useState<Lang>(detectLanguage);

    const setLang = (newLang: Lang) => {
        setLangState(newLang);
        localStorage.setItem('sekure-lang', newLang);
    };

    const t = (key: string): string => {
        return translations[lang][key] || translations['es'][key] || key;
    };

    return (
        <LanguageContext.Provider value={{ lang, setLang, t }}>
            {children}
        </LanguageContext.Provider>
    );
}
